@use "sass:map";
@use "../utils";
@use "../theme/colors";
@use "../theme/theme";
@use "../transition/transition";

/// ripple | press | both | null
$mode: ripple !default;
$disable-focus-background: false !default;

$pressed-class-name: "rmd-pressed";

/// Setting this value to `true` will update the styles for all interactable
/// elements so that the different interaction states no longer cover the other
/// content within the element by applying:
///
/// ```scss
/// > * {
///   z-index: 1;
/// }
/// ```
///
/// This helps improve the legibility of the content since the normal
/// interaction states apply an overlay with some opacity for the different
/// states.
$disable-higher-contrast: false !default;
$light-theme-base-background-color: #000 !default;
$dark-theme-base-background-color: #fff !default;

$outline-color: colors.$blue-500 !default;
$outline-width: 0.125rem !default;
$outline-box-shadow: false !default;

$light-theme-ripple-background-color: rgba(
  $light-theme-base-background-color,
  0.08
) !default;
$dark-theme-ripple-background-color: rgba(
  $dark-theme-base-background-color,
  0.12
) !default;
$ripple-background-color: if(
  theme.$color-scheme == dark,
  $dark-theme-ripple-background-color,
  $light-theme-ripple-background-color
) !default;
$ripple-transform-duration: 0.45s !default;
$ripple-opacity-duration: 0.3s !default;

$light-theme-hover-background-color: rgba(
  $light-theme-base-background-color,
  0.08
) !default;
$light-theme-focus-background-color: rgba(
  $light-theme-base-background-color,
  0.24
) !default;
$light-theme-press-background-color: rgba(
  $light-theme-base-background-color,
  0.32
) !default;
$light-theme-selected-background-color: rgba(
  $light-theme-base-background-color,
  0.16
) !default;
$dark-theme-hover-background-color: rgba(
  $dark-theme-base-background-color,
  0.1
) !default;
$dark-theme-focus-background-color: rgba(
  $dark-theme-base-background-color,
  0.12
) !default;
$dark-theme-press-background-color: rgba(
  $dark-theme-base-background-color,
  0.16
) !default;
$dark-theme-selected-background-color: rgba(
  $dark-theme-base-background-color,
  0.12
) !default;

$hover-background-color: if(
  theme.$color-scheme == dark,
  $dark-theme-hover-background-color,
  $light-theme-hover-background-color
) !default;
$focus-background-color: if(
  theme.$color-scheme == dark,
  $dark-theme-focus-background-color,
  $light-theme-focus-background-color
) !default;
$press-background-color: if(
  theme.$color-scheme == dark,
  $dark-theme-press-background-color,
  $light-theme-press-background-color
) !default;
$selected-background-color: if(
  theme.$color-scheme == dark,
  $dark-theme-selected-background-color,
  $light-theme-selected-background-color
) !default;

$var-lookup: (
  ripple-background-color: (
    var: --rmd-ripple-background-color,
    value: $ripple-background-color,
  ),
  background-color: (
    var: --rmd-interaction-background-color,
    value: null,
  ),
  hover-background-color: (
    var: --rmd-interaction-hover-background-color,
    value: $hover-background-color,
  ),
  focus-background-color: (
    var: --rmd-interaction-focus-background-color,
    value: $focus-background-color,
  ),
  press-background-color: (
    var: --rmd-interaction-press-background-color,
    value: $press-background-color,
  ),
  selected-background-color: (
    var: --rmd-interaction-selected-background-color,
    value: $selected-background-color,
  ),
  outline-color: (
    var: --rmd-outline-color,
    value: $outline-color,
  ),
  outline-width: (
    var: --rmd-outline-width,
    value: $outline-width,
  ),
);

@function get-var($name, $fallback: null) {
  $found: utils.validate($var-lookup, $name, "interaction var");
  $var: map.get($found, var);
  $value: if($fallback, $fallback, map.get($found, value));

  @if $value {
    @return var(#{$var}, #{$value});
  }

  @return var(#{$var});
}

@mixin set-var($name, $value) {
  $var: map.get(utils.validate($var-lookup, $name, "interaction var"), var);

  #{$var}: #{$value};
}

@mixin use-var($property, $name: $property, $fallback: null) {
  #{$property}: get-var($name, $fallback);
}

@mixin use-light-theme {
  @include set-var(hover-background-color, $light-theme-hover-background-color);
  @include set-var(focus-background-color, $light-theme-focus-background-color);
  @include set-var(press-background-color, $light-theme-press-background-color);
  @include set-var(
    selected-background-color,
    $light-theme-selected-background-color
  );
  @include set-var(
    ripple-background-color,
    $light-theme-ripple-background-color
  );
}

@mixin use-dark-theme {
  @include set-var(hover-background-color, $dark-theme-hover-background-color);
  @include set-var(focus-background-color, $dark-theme-focus-background-color);
  @include set-var(press-background-color, $dark-theme-press-background-color);
  @include set-var(
    selected-background-color,
    $dark-theme-selected-background-color
  );
  @include set-var(
    ripple-background-color,
    $dark-theme-ripple-background-color
  );
}

@if $mode and $mode != ripple and $mode != press and $mode != both {
  @error "$mode must be one of: ripple, press, both, or null but was #{$mode}";
}

@mixin outline($box-shadow: $outline-box-shadow) {
  @if $box-shadow {
    box-shadow: inset
      0
      0
      0
      get-var(outline-width)
      get-var(outline-color, transparent);
  } @else {
    outline: get-var(outline-color, transparent) solid get-var(outline-width);
    // adding an outline-offset makes it so it behaves the same way as an inset
    // box shadow
    outline-offset: utils.negate-var(get-var(outline-width));
  }
}

@mixin focus-styles {
  @include set-var(background-color, get-var(focus-background-color));
  @include set-var(outline-color, $outline-color);
}

@mixin surface(
  $focus-selector: "&:focus",
  $disabled-selector: "&:disabled",
  $clickable: true,
  $hoverable: true,
  $css-modules: false,
  $higher-contrast: true,
  $box-shadow: $outline-box-shadow
) {
  @if $clickable {
    cursor: pointer;
  }
  position: relative;
  outline: none;

  @if not $disable-higher-contrast and $higher-contrast {
    > * {
      z-index: 1;
    }
  }

  &::before {
    @include utils.pseudo-element;
    @include outline($box-shadow);
    @if $hoverable {
      @include use-var(background-color);
    }

    transition-property: background-color, outline-color;
    transition-duration: transition.$linear-duration;
    transition-timing-function: transition.$linear-timing-function;
  }

  @if $focus-selector {
    @include utils.keyboard-only($css-modules) {
      #{$focus-selector + "::before"} {
        @include focus-styles;
      }
    }
  }

  @if $hoverable {
    &:hover::before {
      @include set-var(background-color, get-var(hover-background-color));
    }

    @include utils.touch-only {
      &:hover::before {
        @include set-var(background-color, transparent);
      }
    }

    @if $mode == press or $mode == both {
      &.#{$pressed-class-name}::before {
        @include set-var(background-color, get-var(press-background-color));
      }
    }
  }

  @if $disabled-selector {
    #{$disabled-selector} {
      @if $clickable {
        cursor: auto;
      }

      @if $hoverable {
        &:hover::before {
          @include set-var(background-color, transparent);
        }
      }
    }
  }
}

@mixin styles {
  @if $mode == ripple or $mode == both {
    .rmd-ripple-container {
      border-radius: inherit;
      inset: 0;
      overflow: hidden;
      pointer-events: none;
      position: absolute;
      z-index: 0 !important;
    }

    .rmd-ripple {
      @include use-var(background-color, ripple-background-color);

      border-radius: 50%;
      position: absolute;
      transform: scale(0);

      &--animating {
        transition: transform
            $ripple-transform-duration
            transition.$deceleration-timing-function,
          opacity
            $ripple-opacity-duration
            transition.$acceleration-timing-function;
      }

      &--scaling {
        transform: scale(1);
      }

      &--fading {
        opacity: 0;
      }
    }
  }
}
