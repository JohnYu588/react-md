@use "sass:map";
@use "sass:list";
@use "../utils";
@use "../theme/colors";
@use "../theme/theme";
@use "../transition/transition";

/// ripple | press | both | null
$mode: ripple !default;
$disable-outline-offset: false !default;
$disable-focus-background: false !default;
$disable-ripple-inset-var: false !default;
$disable-ripple-border-radius-var: false !default;
$disable-surface-inset-var: false !default;
$disable-surface-border-radius-var: false !default;

$_disable-ripple: not
  list.index(
    (ripple, both),
    utils.validate((ripple, press, both, null), $mode, "interaction mode")
  );

$pressed-class-name: "rmd-pressed";

/// Setting this value to `true` will update the styles for all interactable
/// elements so that the different interaction states no longer cover the other
/// content within the element by applying:
///
/// ```scss
/// > * {
///   z-index: 1;
/// }
/// ```
///
/// This helps improve the legibility of the content since the normal
/// interaction states apply an overlay with some opacity for the different
/// states.
$disable-higher-contrast: false !default;
$light-surface-base-background-color: #000 !default;
$dark-surface-base-background-color: #fff !default;

$focus-color: colors.$blue-500 !default;
$focus-width: 0.125rem !default;
$focus-box-shadow: false !default;

$light-surface-ripple-background-color: rgba(
  $light-surface-base-background-color,
  0.08
) !default;
$dark-surface-ripple-background-color: rgba(
  $dark-surface-base-background-color,
  0.12
) !default;
$ripple-background-color: theme.get-default-color(
  $light-surface-ripple-background-color,
  $dark-surface-ripple-background-color
) !default;
$ripple-transform-duration: 0.45s !default;
$ripple-opacity-duration: 0.3s !default;

$light-surface-hover-opacity: 0.08 !default;
$light-surface-focus-opacity: 0.24 !default;
$light-surface-press-opacity: 0.32 !default;
$light-surface-selected-opacity: 0.16 !default;
$light-surface-hover-background-color: rgba(
  $light-surface-base-background-color,
  $light-surface-hover-opacity
) !default;
$light-surface-focus-background-color: rgba(
  $light-surface-base-background-color,
  $light-surface-focus-opacity
) !default;
$light-surface-press-background-color: rgba(
  $light-surface-base-background-color,
  $light-surface-press-opacity
) !default;
$light-surface-selected-background-color: rgba(
  $light-surface-base-background-color,
  $light-surface-selected-opacity
) !default;

$dark-surface-hover-opacity: 0.1 !default;
$dark-surface-focus-opacity: 0.12 !default;
$dark-surface-press-opacity: 0.24 !default;
$dark-surface-selected-opacity: 0.12 !default;
$dark-surface-hover-background-color: rgba(
  $dark-surface-base-background-color,
  $dark-surface-hover-opacity
) !default;
$dark-surface-focus-background-color: rgba(
  $dark-surface-base-background-color,
  $dark-surface-focus-opacity
) !default;
$dark-surface-press-background-color: rgba(
  $dark-surface-base-background-color,
  $dark-surface-press-opacity
) !default;
$dark-surface-selected-background-color: rgba(
  $dark-surface-base-background-color,
  $dark-surface-selected-opacity
) !default;

$hover-background-color: theme.get-default-color(
  $light-surface-hover-background-color,
  $dark-surface-hover-background-color
) !default;
$focus-background-color: theme.get-default-color(
  $light-surface-focus-background-color,
  $dark-surface-focus-background-color
) !default;
$press-background-color: theme.get-default-color(
  $light-surface-press-background-color,
  $dark-surface-press-background-color
) !default;
$selected-background-color: theme.get-default-color(
  $light-surface-selected-background-color,
  $dark-surface-selected-background-color
) !default;

$variables: (
  background-color,
  hover-background-color,
  focus-background-color,
  press-background-color,
  selected-background-color,
  focus-color,
  focus-width,
  ripple-inset,
  ripple-border-radius,
  ripple-background-color,
  surface-inset,
  surface-border-radius
);

@function _is-var-disabled($name) {
  @if $name == ripple-inset {
    @return $disable-ripple-inset-var;
  }

  @if $name == ripple-border-radius {
    @return $disable-ripple-border-radius-var;
  }

  @if $name == surface-inset {
    @return $disable-surface-inset-var;
  }

  @if $name == surface-border-radius {
    @return $disable-surface-border-radius-var;
  }

  @return false;
}

@function get-var($name, $fallback: null) {
  // cannot set a custom property to `inherit` for some reason. It will not be parsed.
  @if not
    $fallback and
    ($name == ripple-border-radius or $name == surface-border-radius)
  {
    $fallback: inherit;
  }

  @if _is-var-disabled($name) {
    @return $fallback;
  }

  $var: utils.get-var-name($variables, $name, "interaction");

  @if $fallback {
    @return var(#{$var}, #{$fallback});
  }

  @return var(#{$var});
}

@mixin set-var($name, $value) {
  @if _is-var-disabled($name) {
    @error '"#{$name}" is currently disabled and cannot be changed. Set "$disable-#{$name}-var" to `true` or remove it from the Sass module overrides.';
  }

  @if $value {
    #{utils.get-var-name($variables, $name, "interaction")}: #{$value};
  }
}

@mixin use-var($property, $name: $property, $fallback: null) {
  #{$property}: get-var($name, $fallback);
}

@mixin use-light-surface {
  @include set-var(
    hover-background-color,
    $light-surface-hover-background-color
  );
  @include set-var(
    focus-background-color,
    $light-surface-focus-background-color
  );
  @include set-var(
    press-background-color,
    $light-surface-press-background-color
  );
  @include set-var(
    selected-background-color,
    $light-surface-selected-background-color
  );
  @if not $_disable-ripple {
    @include set-var(
      ripple-background-color,
      $light-surface-ripple-background-color
    );
  }
}

@mixin use-dark-surface {
  @include set-var(
    hover-background-color,
    $dark-surface-hover-background-color
  );
  @include set-var(
    focus-background-color,
    $dark-surface-focus-background-color
  );
  @include set-var(
    press-background-color,
    $dark-surface-press-background-color
  );
  @include set-var(
    selected-background-color,
    $dark-surface-selected-background-color
  );
  @if not $_disable-ripple {
    @include set-var(
      ripple-background-color,
      $dark-surface-ripple-background-color
    );
  }
}

@mixin outline(
  $box-shadow: $focus-box-shadow,
  $color: transparent,
  $outline-offset: not $disable-outline-offset
) {
  // do not apply box shadow styles here. they will only be applied in the
  // `focus-styles` mixin to minimize bundle size and help with overriding the
  // focus color in specific surfaces
  @if not $box-shadow {
    outline: $color solid get-var(focus-width);
    // adding an focus-offset makes it so it behaves the same way as an inset
    // box shadow
    @if $outline-offset {
      outline-offset: utils.negate-var(get-var(focus-width));
    }
  }
}

@mixin focus-styles(
  $box-shadow: $focus-box-shadow,
  $disable-background: $disable-focus-background
) {
  @if not $disable-background {
    @include set-var(background-color, get-var(focus-background-color));
  }

  @if $box-shadow {
    box-shadow: inset 0 0 0 get-var(focus-width) get-var(focus-color);
  } @else {
    @include use-var(outline-color, focus-color);
  }
}

@mixin surface-disabled($clickable: true, $hoverable: true) {
  @if $clickable {
    cursor: auto;
  }

  @if $hoverable {
    &:hover::before {
      @include set-var(background-color, transparent);
    }
  }
}

@mixin surface(
  $focus-selector: "&:focus",
  $disabled-selector: "&:disabled",
  $clickable: true,
  $hoverable: true,
  $css-modules: false,
  $higher-contrast: true,
  $box-shadow: $focus-box-shadow,
  $disable-background: $disable-focus-background
) {
  @if $clickable {
    cursor: pointer;
  }
  outline: 0;
  position: relative;

  @if not $disable-higher-contrast and $higher-contrast {
    > * {
      z-index: 1;
    }
  }

  &::before {
    @include utils.pseudo-element(
      $inset: get-var(surface-inset),
      $border-radius: get-var(surface-border-radius)
    );
    @include outline($box-shadow);
    @if $hoverable {
      @include use-var(background-color);
    }

    transition-duration: transition.$linear-duration;
    transition-property: background-color,
      if($focus-box-shadow, box-shadow, outline-color);
    transition-timing-function: transition.$linear-timing-function;
  }

  @if $focus-selector {
    @include utils.keyboard-only($css-modules) {
      #{$focus-selector + "::before"} {
        @include focus-styles($box-shadow, $disable-background);
      }
    }
  }

  @if $hoverable {
    &:hover::before {
      @include set-var(background-color, get-var(hover-background-color));
    }

    @include utils.touch-only {
      &:hover::before {
        @include set-var(background-color, transparent);
      }
    }

    @if $mode == press or $mode == both {
      &.#{$pressed-class-name}::before {
        @include set-var(background-color, get-var(press-background-color));
      }
    }
  }

  @if $disabled-selector {
    #{$disabled-selector} {
      @include surface-disabled($clickable, $hoverable);
    }
  }
}

@mixin variables {
  @include set-var(focus-color, $focus-color);
  @include set-var(focus-width, $focus-width);
  @include set-var(hover-background-color, $hover-background-color);
  @include set-var(focus-background-color, $focus-background-color);
  @include set-var(press-background-color, $press-background-color);
  @include set-var(selected-background-color, $selected-background-color);

  @if not $_disable-ripple {
    @include set-var(ripple-background-color, $ripple-background-color);
    @include set-var(ripple-inset, 0);
  }

  @if not $disable-surface-inset-var {
    @include set-var(surface-inset, 0);
  }
}

@mixin styles {
  @if not $_disable-ripple {
    .rmd-ripple-container {
      @include use-var(border-radius, ripple-border-radius);
      @include use-var(inset, ripple-inset);

      overflow: hidden;
      pointer-events: none;
      position: absolute;
      z-index: 0 !important;
    }

    .rmd-ripple {
      @include use-var(background-color, ripple-background-color);

      border-radius: 50%;
      position: absolute;
      transform: scale(0);

      &--animating {
        transition:
          transform
            $ripple-transform-duration
            transition.$deceleration-timing-function,
          opacity
            $ripple-opacity-duration
            transition.$acceleration-timing-function;
      }

      &--scaling {
        transform: scale(1);
      }

      &--fading {
        opacity: 0;
      }
    }
  }

  .rmd-interaction-surface {
    @include surface($disabled-selector: "&:disabled,&[aria-disabled='true']");
  }
}
