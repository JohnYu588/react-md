@use "sass:map";
@use "../utils";
@use "../theme/colors";
@use "../theme/theme";
@use "../transition/transition";

/// ripple | press | both | null
$interaction-mode: ripple !default;
$disable-focus-background: false !default;

$pressed-class-name: "rmd-pressed";

/// Setting this value to `true` will update the styles for all interactable
/// elements so that the different interaction states no longer cover the other
/// content within the element by applying:
///
/// ```scss
/// > * {
///   z-index: 1;
/// }
/// ```
///
/// This helps improve the legibility of the content since the normal
/// interaction states apply an overlay with some opacity for the different
/// states.
$disable-higher-contrast-interactions: false !default;
$light-theme-base-background-color: #000 !default;
$dark-theme-base-background-color: #fff !default;

$outline-color: colors.$blue-500 !default;
$outline-width: 0.125rem !default;
$outline-box-shadow: false !default;

$light-theme-ripple-background-color: rgba(
  $light-theme-base-background-color,
  0.08
) !default;
$dark-theme-ripple-background-color: rgba(
  $dark-theme-base-background-color,
  0.12
) !default;
$ripple-background-color: if(
  theme.$color-scheme == dark,
  $dark-theme-ripple-background-color,
  $light-theme-ripple-background-color
) !default;
$ripple-transform-duration: 0.45s !default;
$ripple-opacity-duration: 0.3s !default;

$light-theme-hover-background-color: rgba(
  $light-theme-base-background-color,
  0.08
) !default;
$light-theme-focus-background-color: rgba(
  $light-theme-base-background-color,
  0.24
) !default;
$light-theme-press-background-color: rgba(
  $light-theme-base-background-color,
  0.32
) !default;
$light-theme-selected-background-color: rgba(
  $light-theme-base-background-color,
  0.16
) !default;
$dark-theme-hover-background-color: rgba(
  $dark-theme-base-background-color,
  0.1
) !default;
$dark-theme-focus-background-color: rgba(
  $dark-theme-base-background-color,
  0.12
) !default;
$dark-theme-press-background-color: rgba(
  $dark-theme-base-background-color,
  0.16
) !default;
$dark-theme-selected-background-color: rgba(
  $dark-theme-base-background-color,
  0.12
) !default;

$hover-background-color: if(
  theme.$color-scheme == dark,
  $dark-theme-hover-background-color,
  $light-theme-hover-background-color
) !default;
$focus-background-color: if(
  theme.$color-scheme == dark,
  $dark-theme-focus-background-color,
  $light-theme-focus-background-color
) !default;
$press-background-color: if(
  theme.$color-scheme == dark,
  $dark-theme-press-background-color,
  $light-theme-press-background-color
) !default;
$selected-background-color: if(
  theme.$color-scheme == dark,
  $dark-theme-selected-background-color,
  $light-theme-selected-background-color
) !default;

$interaction-var-lookup: (
  ripple-background-color: (
    var: --rmd-ripple-background-color,
    value: $ripple-background-color,
  ),
  background-color: (
    var: --rmd-interaction-background-color,
    value: null,
  ),
  hover-background-color: (
    var: --rmd-interaction-hover-background-color,
    value: $hover-background-color,
  ),
  focus-background-color: (
    var: --rmd-interaction-focus-background-color,
    value: $focus-background-color,
  ),
  press-background-color: (
    var: --rmd-interaction-press-background-color,
    value: $press-background-color,
  ),
  selected-background-color: (
    var: --rmd-interaction-selected-background-color,
    value: $selected-background-color,
  ),
  outline-color: (
    var: --rmd-outline-color,
    value: $outline-color,
  ),
  outline-width: (
    var: --rmd-outline-width,
    value: $outline-width,
  ),
);

@function get-interaction-var($name, $fallback: null) {
  $found: utils.validate($interaction-var-lookup, $name, "interaction var");
  $var: map.get($found, var);
  $value: if($fallback, $fallback, map.get($found, value));

  @if $value {
    @return var(#{$var}, #{$value});
  }

  @return var(#{$var});
}

@mixin set-interaction-var($name, $value) {
  $var: map.get(
    utils.validate($interaction-var-lookup, $name, "interaction var"),
    var
  );

  #{$var}: #{$value};
}

@mixin use-interaction-var($property, $name: $property, $fallback: null) {
  #{$property}: get-interaction-var($name, $fallback);
}

@mixin use-interaction-light-theme {
  @include set-interaction-var(
    hover-background-color,
    $light-theme-hover-background-color
  );
  @include set-interaction-var(
    focus-background-color,
    $light-theme-focus-background-color
  );
  @include set-interaction-var(
    press-background-color,
    $light-theme-press-background-color
  );
  @include set-interaction-var(
    selected-background-color,
    $light-theme-selected-background-color
  );
  @include set-interaction-var(
    ripple-background-color,
    $light-theme-ripple-background-color
  );
}

@mixin use-interaction-dark-theme {
  @include set-interaction-var(
    hover-background-color,
    $dark-theme-hover-background-color
  );
  @include set-interaction-var(
    focus-background-color,
    $dark-theme-focus-background-color
  );
  @include set-interaction-var(
    press-background-color,
    $dark-theme-press-background-color
  );
  @include set-interaction-var(
    selected-background-color,
    $dark-theme-selected-background-color
  );
  @include set-interaction-var(
    ripple-background-color,
    $dark-theme-ripple-background-color
  );
}

@if $interaction-mode and
  $interaction-mode !=
  ripple and
  $interaction-mode !=
  press and
  $interaction-mode !=
  both
{
  @error "$interaction-mode must be one of: ripple, press, both, or null but was #{$interaction-mode}";
}

@mixin keyboard-only($css-modules: false, $parent-selector: true) {
  @include utils.optional-css-modules(
    ".keyboard-mode",
    $css-modules,
    $parent-selector
  ) {
    @content;
  }
}

@mixin mouse-only($css-modules: false) {
  @include utils.optional-css-modules(".mouse-mode", $css-modules) {
    @content;
  }
}

@mixin touch-only($css-modules: false) {
  @include utils.optional-css-modules(".touch-mode", $css-modules) {
    @content;
  }
}

@mixin use-interaction-outline($box-shadow: $outline-box-shadow) {
  @if $box-shadow {
    box-shadow: inset
      0
      0
      0
      get-interaction-var(outline-width)
      get-interaction-var(outline-color, transparent);
  } @else {
    outline: get-interaction-var(outline-color, transparent)
      solid
      get-interaction-var(outline-width);
    // adding an outline-offset makes it so it behaves the same way as an inset
    // box shadow
    outline-offset: utils.negate-var(get-interaction-var(outline-width));
  }
}

@mixin interaction-focus-styles {
  @include set-interaction-var(
    background-color,
    get-interaction-var(focus-background-color)
  );
  @include set-interaction-var(outline-color, $outline-color);
}

@mixin interaction-surface(
  $focus-selector: "&:focus",
  $disabled-selector: "&:disabled",
  $clickable: true,
  $hoverable: true,
  $css-modules: false,
  $higher-contrast: true,
  $box-shadow: $outline-box-shadow
) {
  @if $clickable {
    cursor: pointer;
  }
  position: relative;
  outline: none;

  @if not $disable-higher-contrast-interactions and $higher-contrast {
    > * {
      z-index: 1;
    }
  }

  &::before {
    @include utils.pseudo-element;
    @include use-interaction-outline($box-shadow);
    @if $hoverable {
      @include use-interaction-var(background-color);
    }

    transition-property: background-color, outline-color;
    transition-duration: transition.$linear-duration;
    transition-timing-function: transition.$linear-timing-function;
  }

  @if $focus-selector {
    @include keyboard-only($css-modules) {
      #{$focus-selector + "::before"} {
        @include interaction-focus-styles;
      }
    }
  }

  @if $hoverable {
    &:hover::before {
      @include set-interaction-var(
        background-color,
        get-interaction-var(hover-background-color)
      );
    }

    @include touch-only {
      &:hover::before {
        @include set-interaction-var(background-color, transparent);
      }
    }

    @if $interaction-mode == press or $interaction-mode == both {
      &.#{$pressed-class-name}::before {
        @include set-interaction-var(
          background-color,
          get-interaction-var(press-background-color)
        );
      }
    }
  }

  @if $disabled-selector {
    #{$disabled-selector} {
      @if $clickable {
        cursor: auto;
      }

      @if $hoverable {
        &:hover::before {
          @include set-interaction-var(background-color, transparent);
        }
      }
    }
  }
}

@mixin interaction {
  @if $interaction-mode == ripple or $interaction-mode == both {
    .rmd-ripple-container {
      border-radius: inherit;
      inset: 0;
      overflow: hidden;
      pointer-events: none;
      position: absolute;
      z-index: 0 !important;
    }

    .rmd-ripple {
      @include use-interaction-var(background-color, ripple-background-color);

      border-radius: 50%;
      position: absolute;
      transform: scale(0);

      &--animating {
        transition: transform
            $ripple-transform-duration
            transition.$deceleration-timing-function,
          opacity
            $ripple-opacity-duration
            transition.$acceleration-timing-function;
      }

      &--scaling {
        transform: scale(1);
      }

      &--fading {
        opacity: 0;
      }
    }
  }
}
